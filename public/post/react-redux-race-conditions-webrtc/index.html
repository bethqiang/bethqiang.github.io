<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>A Story of React, Redux, Race Conditions, and Real-Time Communication &middot; Beth Qiang</title>
  <meta name="author" content="Beth Qiang">
  <meta name="description" content="A developer&#39;s thoughts on life, code, and the pursuit of happiness.">
  <meta name="generator" content="Hugo 0.18.1" />
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <!-- RSS autodiscovery -->
  

  <link rel="shortcut icon" href="http://bethqiang.com/img/favicon.ico">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="http://bethqiang.com/css/main.css">
  <link rel="stylesheet" href="http://bethqiang.com/css/github.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/styles/default.min.css">

  

  <!-- Stylesheet for theme color -->
  <style type="text/css">
  a {color: #3498db;}
  .pagination a {color: #3498db;}
  .gist .gist-file .gist-meta {color: #3498db !important;}
  a:focus, a:hover {color: #2079b4;}
  h1.post-title a:focus, h1.post-title a:hover, h1.blog-title a:focus, h1.blog-title a:hover {color: #2079b4;}
  .older-posts:hover, .newer-posts:hover {color: #2079b4;}
</style>
</head>

<body class="home-template">
  <div class="site-header">
  <nav class="site-nav">
    <a href="#" id="menu-icon" class="menu-icon">
      <svg viewBox="0 0 18 15">
        <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"
        />
        <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"
        />
        <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"
        />
      </svg>
    </a>

    <div class="trigger">
      <div class="social">
        
          <a href="//twitter.com/bethqiang" target="_blank" title="Twitter" class="contact-icon"><i class="fa fa-twitter"></i></a>
        
        
          <a href="//github.com/bethqiang" target="_blank" title="GitHub" class="contact-icon"><i class="fa fa-github"></i></a>
        
        
          <a href="//www.linkedin.com/in/bethqiang08" target="_blank" title="linkedIn" class="contact-icon"><i class="fa fa-linkedin"></i></a>
        
        
          <a href="mailto:you@example.com" target="_blank" title="Email" class="contact-icon"><i class="fa fa-envelope"></i></a>
        
        
      </div>

      <div class="main-nav">
        <a href="http://bethqiang.com/" class="page-link">Blog</a>
        
          <a href="about/" class="page-link">About</a>
        
          <a href="portfolio/" class="page-link">Portfolio</a>
        
      </div>
    </div>
  </nav>
</div>


  <main class="content" role="main">
    
  <article class="post">
    <header>
      <h1 class="post-title">A Story of React, Redux, Race Conditions, and Real-Time Communication</h1>
      <div class="post-meta">
        
          <time datetime="January 30, 2017">
            January 30, 2017
          </time>
        
      </div>
    </header>

    <section class="post-content">
      

<p>Most of our work on our Capstone project this past week has been trying to set up the base for what we&rsquo;ll be building the super cool features off of. So far, I ported <a href="http://bethqiang.com/post/how-to-develop-a-vr-app-prototype/" target="_blank">my prototype</a> over, put React in, took React out, put React in again, put Redux and Immutable.js in, fixed race conditions (race conditions and I have grown a little too familiar with each other for my liking), and learned an important lesson about <code>querySelector</code>. I&rsquo;ve also attempted to aid in implementing WebRTC, which has turned out to be surprisingly frustrating.</p>

<h2 id="react-and-a-frame">React and A-Frame</h2>

<p>We put React in initially because we thought it&rsquo;d be a nice-to-have. Then we realized that, for our base MVP at least, we definitely wouldn&rsquo;t be using it to any meaningful degree. A-Frame and React also don&rsquo;t necessarily always play nice with each other; A-Frame is an entity-component-system framework, which favors composability over inheritance. React, on the other hand, is based on inheritance. One of the reasons React is so performant is that it batches its updates; however, when we&rsquo;re going for 60 or 90fps+ real-time rendering, that&rsquo;s maybe not quite what we want.</p>

<p>Despite this, using React with A-Frame does have a few benefits. First, as long as we&rsquo;re able to let A-Frame do the 3D and VR bits, React does a great job at what it was meant for: a view layer and managing state. Furthermore, I&rsquo;ve heard that wrapping React over three.js (our other possible option) results in a lot of performance issues, but A-Frame provides the much-needed bridge between the 3D/VR world and React, lessening that performance hit by a not insignificant amount.</p>

<p>We ultimately decided that if we do want to have various views in the future (which ideally we will, at least on the desktop version), it&rsquo;d be better to have React in from the start, rather than needing to go back later to finagle it back in and make it play nice with everything already there. We&rsquo;ve been told in our initial code review that, despite having React in our app, (1) it&rsquo;s very un-React like and we could probably do more React-ifying, which I definitely want to look into soon and (2) it almost resembles an Angular app, because it&rsquo;s very event-based right now.</p>

<h2 id="redux-and-immutable-js">Redux and Immutable.js</h2>

<p>I threw Redux into both ends as well, and converted our state to use Immutable.js. Using Redux on the back-end was an entirely new experience and it took an afternoon to go baby-step-by-baby-step to un-boggle my brain, but once I realized that it was <em>the exact same</em> as Redux on the front-end — you dispatch an action, and your reducer changes the state based on that action — everything pretty much clicked afterwards.</p>

<p>As I was adding in Immutable.js, I learned an interesting tidbit: socket.io doesn&rsquo;t really understand Immutable collections and ends up converting them to plain JavaScript structures when sending them across the Internet. We were exceptionally confused for a short period of time when our back-end was supposedly sending an Immutable Map and our front-end could access properties on it like it was a normal object.</p>

<h2 id="another-race-condition">Another Race Condition</h2>

<h3 id="or-when-i-learn-that-getelementbyid-queryselector-true">Or, when I learn that getElementById &gt; querySelector === true</h3>

<p>We also had another race condition emerge that is strangely absent in my prototype. When a new user joined and there were existing users in the &ldquo;room,&rdquo; the back-end would sometimes start pushing this new user&rsquo;s updates to the front-ends of everyone else before the new user had been able to be added to everyone else&rsquo;s DOM. The <code>newUser</code> function and the <code>updateUsers</code> function were originally separate:</p>

<pre><code>socket.on('newUser', user =&gt; {
  console.log('Someone else has joined');
  putUserOnDOM(user);
});

socket.on('usersUpdated', users =&gt; {
  console.log('Updating position for all users');
  Object.keys(users).forEach(user =&gt; {
    const otherAvatar = document.querySelector(`#${users[user].id}`);
    otherAvatar.setAttribute('position', `${users[user].x} ${users[user].y} ${users[user].z}`);
    otherAvatar.setAttribute('rotation', `${users[user].xrot} ${users[user].yrot} ${users[user].zrot}`);
  });
});
</code></pre>

<p>To get rid of the race condition that this caused, I ended up implementing a conditional statement — if the element didn&rsquo;t exist on the DOM, add it. If it did, then update as normal.</p>

<pre><code>socket.on('usersUpdated', users =&gt; {
  Object.keys(users).forEach(user =&gt; {
    const otherAvatar = document.querySelector(`#${users[user].id}`);
    if (!otherAvatar) {
      putUserOnDOM(users[user]);
    } else {
      otherAvatar.setAttribute('position', `${users[user].x} ${users[user].y} ${users[user].z}`);
      otherAvatar.setAttribute('rotation', `${users[user].xrot} ${users[user].yrot} ${users[user].zrot}`);
    }
  });
});
</code></pre>

<p>Even after implementing this, we were having issues with the <code>querySelector</code> — there seemed to be times that the <code>querySelector</code> errored out, which prevented the <code>if</code> statement from ever being executed, which means the user was never put on the DOM. As you can imagine, that&rsquo;s a small problem. So, instead, I decided to use <code>getElementById</code> (which I hadn&rsquo;t tried in the first place because the majority of A-Frame examples I had seen used <code>querySelector</code>). Since it was a guarantee that <code>getElementById</code> would return <code>null</code> if the element didn&rsquo;t exist, we could ensure that the <code>if</code> statement would execute when it needed to.</p>

<p>I later discovered that in order to use <code>querySelector</code> on IDs that are numbers, you sometimes <a href="http://stackoverflow.com/questions/20306204/using-queryselector-with-ids-that-are-numbers" target="_blank">need to handle them in special ways</a>. So, the reason it only sometimes freaked out on us was because our IDs were simply socket IDs, only some of them started with numbers. The more you know!</p>

<h2 id="real-time-audio-communication">Real-Time Audio Communication</h2>

<p>Though I hadn&rsquo;t done a lot of WebRTC outside of my initial research when putting together my prototype, I started helping one of my teammates implement WebRTC. He had gotten <em>really</em> close over the past few days, but still not quite there — two browsers were connected, but audio still wasn&rsquo;t streaming from one to the other. We ended up attempting to use the <a href="https://simplewebrtc.com/" target="_blank">SimpleWebRTC library</a>, which we knew <em>was physically possible</em> to integrate with our socket structure, but something about it was just not happy with our sockets. So, we moved on to reimplementing from scratch. TBD on how that turns out, but fingers crossed!</p>

    </section>

    
      <section class="post-tags" style="padding-bottom:60px;">
        <div class="post-meta tags">
          <i class="fa fa-fw fa-tag"></i>
          
            
            <a href="http://bethqiang.com/tags/fullstack-academy" class="tag-comma-separate">fullstack academy</a>
          
            
            <a href="http://bethqiang.com/tags/senior-phase" class="tag-comma-separate">senior phase</a>
          
            
            <a href="http://bethqiang.com/tags/vr" class="tag-comma-separate">vr</a>
          
            
            <a href="http://bethqiang.com/tags/capstone-project" class="tag-comma-separate">capstone project</a>
          
        </div>
      </section>

      <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'bethqiang';
    var disqus_identifier = 'http:\/\/bethqiang.com\/post\/react-redux-race-conditions-webrtc\/';
    var disqus_title = 'A Story of React, Redux, Race Conditions, and Real-Time Communication';
    var disqus_url = 'http:\/\/bethqiang.com\/post\/react-redux-race-conditions-webrtc\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      <section class="share">
  <p class="info prompt">Share</p>
  <a href="http://twitter.com/share?text=A%20Story%20of%20React%2c%20Redux%2c%20Race%20Conditions%2c%20and%20Real-Time%20Communication&url=http%3a%2f%2fbethqiang.com%2fpost%2freact-redux-race-conditions-webrtc%2f" title="Share on Twitter" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
    <i class="fa fa-2x fa-fw fa-twitter-square"></i> <span class="hidden">Twitter</span>
  </a>
  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fbethqiang.com%2fpost%2freact-redux-race-conditions-webrtc%2f" title="Share on Facebook" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
    <i class="fa fa-2x fa-fw fa-facebook-square" style="margin-left: -8px"></i> <span class="hidden">Facebook</span>
  </a>
  <a href="https://plus.google.com/share?url=http%3a%2f%2fbethqiang.com%2fpost%2freact-redux-race-conditions-webrtc%2f" title="Share on Google+" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
    <i class="fa fa-2x fa-fw fa-google-plus-square" style="margin-left: -8px"></i> <span class="hidden">Google+</span>
  </a>
</section>

      <footer class="post-footer">
        <section class="author">
  <div class="authorimage" style="background: url(http://bethqiang.com/images/avatar.jpg)"></div>
  <h4>Beth Qiang</h4>
  <p class="bio">developer - runner - animal lover - food enthusiast</p>
  <p class="meta">
    <i class="fa fa-fw fa-map-marker"></i> Austin, TX
  </p>
</section>

      </footer>
    
  </article>

  </main>

  <a href="javascript:">
  <div id="back-to-top">
    <p class="backtotop">
      <i class="fa fa-lg fa-angle-double-up"></i>
      <a class="backtotoptext">Back to top</a>
    </p>
  </div>
</a>

  <footer class="site-footer">
  <div class="inner">
    <section class="copyright">A developer&rsquo;s thoughts on life, code, and the pursuit of happiness.</section>
  </div>
</footer>

  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="http://bethqiang.com/js/index.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-85574806-1', 'auto');
ga('send', 'pageview');
</script>

</body>
</html>